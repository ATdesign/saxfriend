var FRET_FIRST_FRET=63,FRET_X_OFFSET=10,FRET_Y_OFFSET=10,FRET_DRAW_TO_FRET=21,FRET_DOTS=[0,3,5,7,9],FRET_DOT_DIAMETER=6,FRET_DOT_DEFAULT_CLASS="fret-dot-default",FRET_DEFAULT_CLASS="fretboard-default",FRET_SHADOW_DEFAULT_CLASS="fretboard-shadow-default",FRET_NUT_DEFAULT_CLASS="fretboard-nut-default",FRET_DEFAULT_MARKER_CLASS="fretboard-marker-default",FRET_WOUND_STRING_SEM_DST=39,FRET_STRING_MIN_DIAM=1,FRET_STRING_MAX_DIAM=8,KEYB_DEFAULT_WHITE_KEY_CLASS="keyboard-white-key-default",KEYB_DEFAULT_BLACK_KEY_CLASS="keyboard-black-key-default",KEYB_DEFAULT_MARKER_CLASS="keyboard-marker-default",CHBUILD_GRID_Y=5,CHBUILD_DEFAULT_MARKER_CLASS="chordbuild-marker",CHBUILD_DEFAULT_CHORD_CLASS="chordbuild-chord",CHBUILD_SELECTED_MARKER="chordbuild-marker-selected",CHBUILD_DEFAULT_ADD_CLASS="chordbuild-add",PROGBUILD_MAJOR_SVG_RELATIONS={"g-majprog-i":"maj","g-majprog-ii":"min","g-majprog-iii":"min","g-majprog-iv":"maj","g-majprog-v":"maj","g-majprog-vi":"min","g-majprog-viidim":"dim"},PROGBUILD_MINOR_SVG_RELATIONS={"g-minprog-i":"min","g-minprog-iidim":"dim","g-minprog-iii":"maj","g-minprog-iv":"min","g-minprog-v":"min","g-minprog-vi":"maj","g-minprog-vii":"maj"},SVG_DIRECTORY="svg/",note_array=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],chord_structures={maj:[4,7],maj6:[4,7,9],maj6add9:[4,7,9,14],maj7:[4,7,11],maj9:[4,7,11,14],dom7:[4,7,10],dom7aug5:[4,8,10],dom7sus4:[5,7,10],dom9:[4,7,10,14],dom9sus4:[5,7,10,14],dom11:[4,7,10,14,17],dom13:[4,7,10,14,17,21],aug:[4,8],min:[3,7],min6:[3,7,9],min7:[3,7,10],min7b5:[3,6,10],min9:[3,7,10,14],min11:[3,7,10,14,17],dim:[3,6],dim7:[3,6,9],sus4:[5,7],sus2:[2,7],add9:[4,7,14]},CHORD_LIST_TEMPLATE='<ul id="chord-list" class="uk-grid-small uk-child-width-1-3 uk-child-width-1-4@s uk-text-center" uk-sortable="handle: .uk-sortable-handle" uk-grid></ul>',CHORD_LIST_CONTROL_TEMPLATE='<div class="chord-player-controls"><span class="chord-play">Play</span> @ <input class="chord-bpm" type="text" value="{{chord-bpm}}"> bpm <span class="import-chord-list">Import</span> <span class="export-chord-list">Export</span></div><div class="chord-player-timeline"></div><div class="chord-player-timeline-measures"></div>',CHORD_LIST_ITEM_TEMPLATE='<div class="uk-card uk-card-default uk-card-body"><div class="chord-header"><span class="uk-sortable-handle" uk-icon="icon: table"></span> <span class="chord-text">{{chord-text}}</span> | <span class="chord-legato">leg.</span><br /></div><div class="chord-option chord-length"><span class="chord-option-label">Length:</span><span class="chord-controls chord-reduce-value" uk-icon="icon: minus-circle;"></span><input type="text" class="chord-text-input" value="{{chord-length}}" /><span class="chord-controls chord-add-value" uk-icon="icon: plus-circle;"></span></div><div class="chord-option chord-octave"><span class="chord-option-label">Octave:</span><span class="chord-controls chord-reduce-value" uk-icon="icon: minus-circle;"></span><input type="text" class="chord-text-input" value="{{chord-octave}}" /><span class="chord-controls chord-add-value" uk-icon="icon: plus-circle;"></span></div><div class="chord-option chord-actions"><span class="chord-controls chord-duplicate">duplicate</span> | <span class="chord-controls chord-delete">delete</span></div></div>',CHORD_LENGTHS=["1/16","1/12","1/8","1/6","1/4","1/3","1/2","1"],CHORD_OCTAVES=[1,2,3,4,5],CHORD_PLAYER_CLASS="chord-player",CHORD_LIST_ID="chord-list",CHORD_LIST_ITEM_CLASS="chord-list-element",chord_list_counter=0,chord_list=[],chord_play_events=[],comptools_config={tempo:120,time_signature:"4/4",play_sound:!0,play_midi:!1,instrument_glue:null,theory:null,chord_player:null,chord_builder:null};function saturate_value(val,minval,maxval){return void 0===minval&&(minval=-1,console.log("Minimum saturation value is undefined! Using defaults.")),void 0===maxval&&(maxval=1,console.log("Maximum saturation value is undefined! Using defaults.")),val<minval&&(val=minval),maxval<val&&(val=maxval),val}function get_duration_in_seconds(dur){var mydur=eval(dur),tempo=120;return void 0!==comptools_config.tempo&&(tempo=comptools_config.tempo),mydur*(240/tempo)}function get_duration_in_ms(dur){return 1e3*get_duration_in_seconds(dur)}function add_chord_to_player(note,chord){var my_chord=new comptoolsChordPlayerElement(note,chord);chord_list.push(my_chord),void 0!==comptools_config.instrument_glue&&(my_chord.selection_callback=comptools_config.instrument_glue.funHighlightChordListElementNotes),void 0!==comptools_config.chord_player&&comptools_config.chord_player.update_callback(),play_chord(note,chord,3,.5)}function play_chord(note,chord,oct,len){var my_notes=get_chord_notes(note,chord,oct);void 0!==comptools_sound_player&&comptools_config.play_sound&&comptools_sound_player.triggerAttackRelease(my_notes,len),void 0!==comptools_midi_player&&comptools_midi_player.ready&&comptools_config.play_midi&&comptools_midi_player.sendOnOffMessage(my_notes,1e3*len)}function player_play_chord(notes,len){void 0!==comptools_sound_player&&comptools_config.play_sound&&comptools_sound_player.triggerAttackRelease(notes,len),void 0!==comptools_midi_player&&comptools_midi_player.ready&&comptools_config.play_midi&&comptools_midi_player.CyclicSendOnMessage(notes)}function get_chord(note,chord){var my_n=note_array.indexOf(note.toUpperCase()),my_c=chord_structures[chord.toLowerCase()],my_notes=new Array;my_notes.push(note);for(var k=0;k<my_c.length;k++)my_notes.push(note_array[(my_n+my_c[k])%note_array.length]);return my_notes}function parse_time_signature(ts){return[parseInt(ts.split("/")[0]),parseInt(ts.split("/")[1])]}function get_chord_notes(note,chord,oct){void 0===oct&&(oct=3);for(var fi_n=note_array.indexOf(note.toUpperCase()),now_notes=new Array,j=0;j<24;j++)now_note=note_array[(fi_n+j)%note_array.length],now_notes.push(now_note+oct),oct+=(fi_n+j+1)%note_array.length==0?1:0;var my_c=chord_structures[chord.toLowerCase()],my_notes=new Array;my_notes.push(now_notes[0]);for(var k=0;k<my_c.length;k++)my_notes.push(now_notes[my_c[k]]);return my_notes}function parse_chord_player(){var play_order_ids=[];d3.selectAll("#"+CHORD_LIST_ID+" ."+CHORD_LIST_ITEM_CLASS).each(function(){play_order_ids.push(d3.select(this).attr("id"))});for(var current_chord,unchanged_chord,chord_selected=-1,k=0;k<play_order_ids.length;k++)if(d3.select("#"+CHORD_LIST_ID+" #"+play_order_ids[k]+" div.uk-card").classed("chord-selected")){chord_selected=k;break}var unchanged_chord_event_ind=0,start_position=0,total_dur=0,chord_play_events=[];for(k=0;k<play_order_ids.length;k++){current_chord=chord_list.get_obj_by_prop("elem_id",play_order_ids[k]),0===k&&(unchanged_chord=current_chord,unchanged_chord_event_ind=0);var do_legato=!1;0<k&&current_chord.my_root===unchanged_chord.my_root&&current_chord.my_chord===unchanged_chord.my_chord&&current_chord.legato&&(do_legato=!0);var now_dur=get_duration_in_seconds(current_chord.get_dur());-1!==chord_selected&&k<chord_selected&&(start_position+=now_dur);var my_event={object:current_chord,highlight_id:current_chord.elem_id,chord_notes:get_chord_notes(current_chord.my_root,current_chord.my_chord,current_chord.get_oct()),highlight_notes:get_chord(current_chord.my_root,current_chord.my_chord),duration:now_dur,interval:now_dur,legato:do_legato};total_dur+=now_dur,chord_play_events.push(my_event),do_legato?chord_play_events[unchanged_chord_event_ind].duration+=get_duration_in_seconds(current_chord.get_dur()):(unchanged_chord=current_chord,unchanged_chord_event_ind=k)}return{events:chord_play_events,selected_chord:chord_selected,start_position:start_position,total_duration:total_dur}}Array.prototype.find_obj_by_prop=function(key,val){for(var found=-1,k=0;k<this.length;k++)if(this[k][key]===val){found=k;break}return found},Array.prototype.get_obj_by_prop=function(key,val){return this[this.find_obj_by_prop(key,val)]},Array.prototype.remove_obj_by_prop=function(key,val){return this.splice(this.find_obj_by_prop(key,val),1),this};var pure_tones=["A","B","C","D","E","F","G"],note_scinot=/([A-G]#?)([0-9])/,note_scifnot=/([A-G])([0-9])/,note_scinot_global=/([A-G]#?)([0-9])/g,scale_defs={major:{ints:[2,2,1,2,2,2],miss:[],add:[]},minor:{ints:[2,1,2,2,1,2],miss:[],add:[]},"major pentatonic":{ints:[2,2,3,2],miss:[4,7],add:[]},"minor pentatonic":{ints:[3,2,2,3],miss:[2,6],add:[]}},all_scales=new Array;for(var property in scale_defs)scale_defs.hasOwnProperty(property)&&all_scales.push(property);function get_scale(note,scale){var my_notes=note_array.slice();if(-1!==note.indexOf("b")&&(my_notes=sharps2flats(my_notes)),scale=scale.toLowerCase(),ind=my_notes.indexOf(note),void 0===ind)return null;var my_scale=new Array;if(scale_defs.hasOwnProperty(scale)){for(var my_pattern=scale_defs[scale].ints,k=0;k<=my_pattern.length;k++)my_scale.push(my_notes[ind]),ind=(ind+my_pattern[k])%my_notes.length;return{notes:my_scale,missing_degrees:scale_defs[scale].miss,additional_degrees:scale_defs[scale].add}}return null}function get_sharps(scale){for(var my_count=0,k=0;k<scale.length;k++)-1!==scale[k].indexOf("#")&&my_count++;return my_count}function sharps2flats(notes){var return_array=!0;notes.constructor!==Array&&(notes=new Array(notes),return_array=!1);for(var new_notes=new Array,k=0;k<notes.length;k++)if(-1!==notes[k].indexOf("#")){var pt_index=pure_tones.indexOf(notes[k][0]);new_notes.push(pure_tones[(pt_index+1)%pure_tones.length]+"b")}else new_notes.push(notes[k]);return return_array?new_notes:new_notes[0]}function flats2sharps(notes){var return_array=!0;notes.constructor!==Array&&(notes=new Array(notes),return_array=!1);for(var new_notes=new Array,k=0;k<notes.length;k++)if(-1!==notes[k].indexOf("b")){var pt_index=pure_tones.indexOf(notes[k][0])-1;pt_index<0&&(pt_index=pure_tones.length-1),new_notes.push(pure_tones[pt_index]+"#")}else new_notes.push(notes[k]);return return_array?new_notes:new_notes[0]}function get_semitone_distance(note){return note=note.toUpperCase(),match=note_scinot.exec(note),note_array.indexOf(match[1])+1+12*parseInt(match[2])}function get_tone_distance(note){return note=note.toUpperCase(),match=note_scifnot.exec(note),note_array.indexOf(match[1])+1+7*parseInt(match[2])}function InstrumentGlue(){this.objArray=new Array,this.theory=null,this.chord_builder=null,this.chord_progressions=null;var self=this;this.funCallback=function(note,action){for(var k=0;k<self.objArray.length;k++)self.objArray[k].updateSingleNote(note,action)},this.funHighlightNotes=function(){for(var myth=self.theory,k=0;k<self.objArray.length;k++)"none"!==myth.scale_data?(self.objArray[k].updateNotes(myth.scale_data.notes),self.chord_progressions.updateChords(myth.root,myth.scale)):(self.objArray[k].clearNotes(),self.chord_progressions.clearChords())},this.funHighlightChordNotes=function(){var mycb=self.chord_builder,show_notes=!1,the_notes=null;"none"!==mycb.current_note&&"none"!==mycb.current_chord&&(show_notes=!0,the_notes=get_chord(mycb.current_note,mycb.current_chord));for(var k=0;k<self.objArray.length;k++)!0===show_notes?self.objArray[k].updateNotes(the_notes):self.objArray[k].clearNotes()},this.funHighlightChordListElementNotes=function(obj,act){if(act){for(var the_notes=get_chord(obj.my_root,obj.my_chord),k=0;k<self.objArray.length;k++)self.objArray[k].updateNotes(the_notes);play_chord(obj.my_root,obj.my_chord,obj.get_oct(),get_duration_in_seconds(obj.get_dur()))}else for(k=0;k<self.objArray.length;k++)self.objArray[k].clearNotes(the_notes)}}function comptoolsTheory(cont_id){var self=this;this.pentatonic_mode=!1,this.root="none",this.scale="none",this.use_flats=!1,this.scale_data="none";var my_theory_svg=SVG_DIRECTORY+"note-relationships.svg";d3.xml(my_theory_svg,function(xml){document.getElementById(cont_id).appendChild(xml.documentElement);var elid="#"+cont_id;self.svg_theory=d3.select(elid).select("svg");var the_conw=parseFloat(d3.select(elid).style("width")),the_conh=parseFloat(d3.select(elid).style("height"));parseFloat(self.svg_theory.attr("width")),parseFloat(self.svg_theory.attr("height"));self.svg_theory.attr("width",the_conw),self.svg_theory.attr("height",the_conh),self.clearNotes(),self.svg_theory.selectAll(".circle-scale").on("click",function(){if(d3.select(this).select(".scale-marker").classed("selected"))d3.select(this).select(".scale-marker").classed("selected",!1),self.root="none",self.scale="none",self.scale_data="none",self.clearAccidentals(),self.clearNotes(),self.selection_callback();else{d3.select(elid).selectAll(".scale-marker").classed("selected",!1);var scale_data=self.parseScale(d3.select(this).attr("id"));self.root=scale_data.note,self.scale=scale_data.scale,d3.select(this).classed("flat-scale")?self.use_flats=!0:self.use_flats=!1,d3.select(this).select(".scale-marker").classed("selected",!0),self.clickHandler()}}),self.svg_theory.select("#scale-pentatonic").on("click",function(){var pent_sel=d3.select(this).select(".pentatonic-marker").classed("selected");pent_sel=!pent_sel,d3.select(this).select(".pentatonic-marker").classed("selected",pent_sel),self.pentatonic_mode=!!pent_sel,"none"!==self.scale&&self.clickHandler()})}),this.parseScale=function(id){return match=/scale-([A-G])(s|b)?(Maj|Min)/gi.exec(id),{note:match[1].toUpperCase()+(void 0===match[2]?"":match[2]).replace("s","#"),scale:match[3].toLowerCase()+"or"}},this.updateAccidentals=function(){this.clearAccidentals();for(var notes=this.scale_data.notes,miss=this.scale_data.missing_degrees,the_pures=pure_tones.slice(),cnt=0;the_pures[0]!==notes[0][0]&&cnt++<8;)the_pures.push(the_pures.shift());for(var k=0;k<miss.length;k++)the_pures.splice(miss[k]-1-k,1);var new_notes=new Array,display_what="f";for(k=0;k<notes.length;k++)-1!==notes[k].indexOf("#")&&(display_what="s"),notes[k]!==the_pures[k]?new_notes.push(the_pures[k]+"!"):new_notes.push(the_pures[k]);var the_class=".clef-"+display_what+"-";for(k=0;k<new_notes.length;k++)if(-1!==new_notes[k].indexOf("!")){var class_to_select=the_class+new_notes[k][0].toLowerCase();this.svg_theory.selectAll(class_to_select).classed("visible-accidental",!0)}return!0},this.clearAccidentals=function(){for(var k=1;k<=7;k++)this.svg_theory.select("#clef-s"+k).classed("visible-accidental",!1),this.svg_theory.select("#clefb-s"+k).classed("visible-accidental",!1),this.svg_theory.select("#clef-f"+k).classed("visible-accidental",!1),this.svg_theory.select("#clefb-f"+k).classed("visible-accidental",!1)},this.updateNotes=function(){for(var notes=this.scale_data.notes,miss=this.scale_data.missing_degrees,ind=0,k=1;k<=8;k++){var this_note="";-1===miss.indexOf(k)&&(this_note=notes[ind++%notes.length]);var my_id="#noterel-"+k+" text";this.svg_theory.select(my_id).text(this_note)}},this.clearNotes=function(){for(var k=1;k<=8;k++){var my_id="#noterel-"+k+" text";this.svg_theory.select(my_id).text("")}},this.get_scale_data=function(){if(void 0!==this.scale&&"none"!==this.scale){var to_get_scale=this.scale+(this.pentatonic_mode?" pentatonic":""),my_scale_data=get_scale(this.root,to_get_scale);this.use_flats&&(my_scale_data.notes=sharps2flats(my_scale_data.notes)),this.scale_data=my_scale_data}else this.scale_data="none"}}function comptoolsChordProgressions(cont_class,root,scale){(void 0===root||void 0===scale)&&(scale=root="none");var self=this;this.root=root,this.scale=scale,this.maj_prog=null,this.min_prog=null;var major_progressions=SVG_DIRECTORY+"major_chord_progressions.svg",minor_progressions=SVG_DIRECTORY+"minor_chord_progressions.svg";d3.select(cont_class).append("div").attr("id","id-major-progressions"),d3.select(cont_class).append("div").attr("id","id-minor-progressions").style("display","none"),d3.xml(major_progressions,function(xml){document.getElementById("id-major-progressions").appendChild(xml.documentElement);var elid="#id-major-progressions";self.maj_prog=d3.select(elid).select("svg");var the_conw=parseFloat(d3.select(elid).style("width")),the_conh=parseFloat(d3.select(elid).style("height"));self.maj_prog.attr("width",the_conw),self.maj_prog.attr("height",the_conh),self.initializeMajorText()}),d3.xml(minor_progressions,function(xml){document.getElementById("id-minor-progressions").appendChild(xml.documentElement);var elid="#id-minor-progressions";self.min_prog=d3.select(elid).select("svg");var the_conw=parseFloat(d3.select(elid).style("width")),the_conh=parseFloat(d3.select(elid).style("height"));self.min_prog.attr("width",the_conw),self.min_prog.attr("height",the_conh),self.initializeMinorText()})}function comptoolsKeyboard(cont_class,range,options){var the_range=range.split("-"),keys_to_draw=get_semitone_distance(the_range[1])-get_semitone_distance(the_range[0]),wh_keys_to_draw=get_tone_distance(the_range[1])-get_tone_distance(the_range[0]);if(keys_to_draw<=0)return null;var keyb_conw=parseFloat(d3.select(cont_class).style("width")),keyb_conh=parseFloat(d3.select(cont_class).style("height")),wh_key_height=keyb_conh,wh_key_width=Math.floor(keyb_conw/wh_keys_to_draw),bl_key_height=Math.floor(5/8*wh_key_height),bl_key_width=Math.floor(wh_key_width/2),marker_rad=Math.floor(.6*wh_key_width),bl_key_offset=Math.floor(bl_key_width/2),marker_bl=bl_key_height-Math.floor(1.5*bl_key_width),marker_wh=wh_key_height-Math.floor(1.6*bl_key_width),wh_offset=Math.floor((wh_key_width-marker_rad)/2),bl_offset=Math.floor((bl_key_width-marker_rad)/2);this.svg_keyboard=d3.select(cont_class).append("svg").attr("width",keyb_conw).attr("height",keyb_conh);var curr_note=the_range[0][0],note_ptr=note_array.indexOf(curr_note.toUpperCase()),curr_note_index=parseInt(the_range[0][1]);bl_buffer=new Array,curr_x_pos=1;for(var k=0;k<keys_to_draw;k++){curr_note=note_array[(note_ptr+k)%note_array.length].toLowerCase(),curr_note_index+=(note_ptr+k)%note_array.length==0?1:0;var now_note_class="note-"+curr_note.replace("#","s"),now_note_num_class="note-"+curr_note.replace("#","s")+curr_note_index,current_note_class=KEYB_DEFAULT_MARKER_CLASS+" keyboard-marker-inactive "+now_note_class+" "+now_note_num_class;-1!==curr_note.indexOf("#")?(save_note={note:curr_note,pos:curr_x_pos-bl_key_offset,class:current_note_class},bl_buffer.push(save_note)):(this.svg_keyboard.append("rect").attr("x",curr_x_pos).attr("y",0).attr("width",wh_key_width).attr("height",wh_key_height).attr("class",KEYB_DEFAULT_WHITE_KEY_CLASS),this.svg_keyboard.append("rect").attr("x",curr_x_pos+wh_offset).attr("y",marker_wh).attr("width",marker_rad).attr("height",marker_rad).attr("class",current_note_class),another_key=bl_buffer.pop(),void 0!==another_key&&(this.svg_keyboard.append("rect").attr("x",another_key.pos).attr("y",0).attr("width",bl_key_width).attr("height",bl_key_height).attr("class",KEYB_DEFAULT_BLACK_KEY_CLASS),this.svg_keyboard.append("rect").attr("x",another_key.pos+bl_offset).attr("y",marker_bl).attr("width",marker_rad).attr("height",marker_rad).attr("class",another_key.class)),curr_x_pos+=wh_key_width)}d3.selectAll("rect."+KEYB_DEFAULT_MARKER_CLASS).on("click",this.clickHandler()),this.updateSingleNote=function(note,display){void 0===display&&(display=!0),this.svg_keyboard.selectAll(".note-"+note.replace("#","s").toLowerCase()).classed("keyboard-marker-selected",display)},this.updateNotes=function(notes,display){this.clearNotes(),notes=flats2sharps(notes),void 0===display&&(display=!0);for(var k=0;k<notes.length;k++){var now_note=notes[k].replace("#","s").toLowerCase();this.svg_keyboard.selectAll(".note-"+now_note).classed("keyboard-marker-highlighted",display),0===k&&this.svg_keyboard.selectAll(".note-"+now_note).classed("keyboard-marker-highlighted-root",display)}},this.clearNotes=function(){this.svg_keyboard.selectAll(".keyboard-marker-highlighted").classed("keyboard-marker-highlighted",!1),this.svg_keyboard.selectAll(".keyboard-marker-highlighted-root").classed("keyboard-marker-highlighted-root",!1)}}function comptoolsFretboard(cont_class,tuning,options){var firstFretWidth=FRET_FIRST_FRET,fretboardClass=FRET_DEFAULT_CLASS,fretboardNutClass=FRET_NUT_DEFAULT_CLASS,fretCount=FRET_DRAW_TO_FRET;void 0!==options&&"object"==typeof options&&null!==options&&(options.hasOwnProperty("firstFretWidth")&&(firstFretWidth=options.firstFretWidth),options.hasOwnProperty("fretboardClass")&&(fretboardClass=options.fretboardClass),options.hasOwnProperty("fretboardNutClass")&&(fretboardNutClass=options.fretboardNutClass),options.hasOwnProperty("fretCount")&&(fretCount=options.fretCount)),this.fret_notes=new Object,this.notes=null,this.tuning=tuning.toUpperCase(),this.cont_class=cont_class,this.svg_fretboard=null,this.updateTuning=function(tuning){null!=tuning&&""!==tuning&&(this.tuning=tuning.toUpperCase());var cont_class=this.cont_class,fret_current_tuning=this.tuning;for(this.saveHighlightedNotes(),d3.select(cont_class).selectAll("*").remove(),this.fret_notes.note=Array(),this.fret_notes.index=Array(),this.fret_notes.full_note=Array(),this.fret_notes.count=null,match=note_scinot_global.exec(fret_current_tuning);null!==match;)this.fret_notes.full_note.push(match[0]),this.fret_notes.note.push(match[1]),this.fret_notes.index.push(match[2]),this.fret_notes.count++,match=note_scinot_global.exec(fret_current_tuning);var fret_conw=parseFloat(d3.select(cont_class).style("width")),fret_conh=parseFloat(d3.select(cont_class).style("height")),fret_w=fret_conw-FRET_X_OFFSET,fret_h=fret_conh-FRET_Y_OFFSET;this.svg_fretboard=d3.select(cont_class).append("svg").attr("width",fret_w).attr("height",fret_h);var fret_string_h=Math.floor(fret_h/(this.fret_notes.count+1)),fret_x_coord=FRET_X_OFFSET,centerPos=Array(),fret_min_width=firstFretWidth,now_fret_size=Math.floor(firstFretWidth/3);fret_min_width=Math.min(fret_min_width,now_fret_size),this.svg_fretboard.append("rect").attr("x",fret_x_coord).attr("y",FRET_Y_OFFSET).attr("width",now_fret_size).attr("height",fret_h).attr("class",fretboardNutClass),centerPos.push(Math.floor(fret_x_coord+now_fret_size/2)),fret_x_coord+=now_fret_size+1;for(var n=1;n<fretCount;n++){now_fret_size=Math.floor(firstFretWidth*Math.exp(-.0655*n));if(centerPos.push(Math.floor(fret_x_coord+now_fret_size/2)),fret_min_width=Math.min(fret_min_width,now_fret_size),this.svg_fretboard.append("rect").attr("x",fret_x_coord).attr("y",FRET_Y_OFFSET).attr("width",now_fret_size).attr("height",fret_h).attr("class",fretboardClass),-1!==FRET_DOTS.indexOf(n%12)){var fret_dot_y=Math.floor(fret_h/2+FRET_Y_OFFSET),fret_dot_x=Math.floor(now_fret_size/2+fret_x_coord),fret_dot_r=Math.floor(FRET_DOT_DIAMETER/2);n%12!=0?this.svg_fretboard.append("circle").attr("cx",fret_dot_x).attr("cy",fret_dot_y).attr("r",fret_dot_r).attr("class",FRET_DOT_DEFAULT_CLASS):(this.svg_fretboard.append("circle").attr("cx",fret_dot_x).attr("cy",Math.floor(fret_dot_y+fret_string_h)).attr("r",fret_dot_r).attr("class",FRET_DOT_DEFAULT_CLASS),this.svg_fretboard.append("circle").attr("cx",fret_dot_x).attr("cy",Math.floor(fret_dot_y-fret_string_h)).attr("r",fret_dot_r).attr("class",FRET_DOT_DEFAULT_CLASS))}fret_x_coord+=now_fret_size}fret_width=fret_x_coord-FRET_X_OFFSET;for(var fret_marker_size=fret_min_width,i=0;i<this.fret_notes.count;i++){var string_index=i+1,sem_distance=get_semitone_distance(this.fret_notes.full_note[i]),string_diameter=Math.round(-4.634*Math.log(sem_distance)+19.259);string_diameter=Math.min(string_diameter,FRET_STRING_MAX_DIAM),string_diameter=Math.max(string_diameter,FRET_STRING_MIN_DIAM),current_string_y=FRET_Y_OFFSET+string_index*fret_string_h,corrn=Math.floor(string_diameter/2),current_string_y-=corrn,current_string_shadow=this.svg_fretboard.append("line").attr("x1",FRET_X_OFFSET).attr("y1",current_string_y+1).attr("x2",FRET_X_OFFSET+fret_width).attr("y2",current_string_y+1).attr("class",FRET_SHADOW_DEFAULT_CLASS).attr("stroke-width",string_diameter),current_string=this.svg_fretboard.append("line").attr("x1",FRET_X_OFFSET).attr("y1",current_string_y).attr("x2",FRET_X_OFFSET+fret_width).attr("y2",current_string_y).attr("class","fret-string").attr("stroke-width",string_diameter),sem_distance<FRET_WOUND_STRING_SEM_DST&&current_string.classed("fret-wound-string",!0),first_note=note_array.indexOf(this.fret_notes.note[i]),first_note_index=parseInt(this.fret_notes.index[i]),half_fret_marker_size=Math.floor(fret_marker_size/2);for(var j=0;j<centerPos.length;j++){now_note=note_array[(first_note+j)%note_array.length],now_note_class="note-"+now_note.replace("#","s").toLowerCase(),now_note_num_class=now_note_class+first_note_index,first_note_index+=(first_note+j+1)%note_array.length==0?1:0;var current_note_class=FRET_DEFAULT_MARKER_CLASS+" fretboard-marker-inactive "+now_note_class+" "+now_note_num_class;fret_marker_x=centerPos[j]-half_fret_marker_size,fret_marker_y=current_string_y-half_fret_marker_size;var now_g=this.svg_fretboard.append("g").attr("class",current_note_class);now_g.append("rect").attr("x",fret_marker_x).attr("y",fret_marker_y).attr("width",fret_marker_size).attr("height",fret_marker_size),now_g.append("text").attr("text-anchor","middle").attr("x",centerPos[j]).attr("y",fret_marker_y+12).text(now_note)}d3.selectAll("g."+FRET_DEFAULT_MARKER_CLASS).on("click",this.clickHandler())}this.restoreHighlightedNotes()},this.updateSingleNote=function(note,display){void 0===display&&(display=!0),this.svg_fretboard.selectAll(".note-"+note.replace("#","s").toLowerCase()).classed("fretboard-marker-selected",display)},this.updateNotes=function(notes,display){this.clearNotes();for(var is_flats=!1,k=0;k<notes.length;k++)-1!==notes[k].indexOf("b")&&(is_flats=!0);is_flats?this.sharps2flats():this.flats2sharps(),notes=flats2sharps(notes),void 0===display&&(display=!0);for(k=0;k<notes.length;k++){var now_note=notes[k].replace("#","s").toLowerCase();this.svg_fretboard.selectAll(".note-"+now_note).classed("fretboard-marker-highlighted",display),0===k&&this.svg_fretboard.selectAll(".note-"+now_note).classed("fretboard-marker-highlighted-root",display)}},this.clearNotes=function(){this.svg_fretboard.selectAll(".fretboard-marker-highlighted").classed("fretboard-marker-highlighted",!1),this.svg_fretboard.selectAll(".fretboard-marker-highlighted-root").classed("fretboard-marker-highlighted-root",!1)},this.accidental_state="sharps",this.sharps2flats=function(){"sharps"===this.accidental_state&&this.svg_fretboard.selectAll("."+FRET_DEFAULT_MARKER_CLASS+" text").each(function(){d3.select(this).text(sharps2flats(d3.select(this).text()))}),this.accidental_state="flats"},this.flats2sharps=function(){"flats"===this.accidental_state&&this.svg_fretboard.selectAll("."+FRET_DEFAULT_MARKER_CLASS+" text").each(function(){d3.select(this).text(flats2sharps(d3.select(this).text()))}),this.accidental_state="sharps"},this.saveHighlightedNotes=function(){if(null!==this.svg_fretboard){var rexp_note=/note-([a-g]s?(?!s?[0-9]))/gi,rexp_noten=/note-([a-g]s?[0-9])/gi,fbh_notes=[],fbhr_notes=[],fbs_notes=[];this.svg_fretboard.selectAll(".fretboard-marker-highlighted").each(function(d,i){var capt_note=rexp_note.exec(d3.select(this).attr("class"))[1].replace("s","#").toUpperCase();rexp_note.lastIndex=0,-1===fbh_notes.indexOf(capt_note)&&fbh_notes.push(capt_note)}),this.svg_fretboard.selectAll(".fretboard-marker-highlighted-root").each(function(d,i){var capt_note=rexp_note.exec(d3.select(this).attr("class"))[1].replace("s","#").toUpperCase();rexp_note.lastIndex=0,-1===fbhr_notes.indexOf(capt_note)&&fbhr_notes.push(capt_note)}),this.svg_fretboard.selectAll(".fretboard-marker-selected").each(function(d,i){var capt_note=rexp_noten.exec(d3.select(this).attr("class"))[1].replace("s","#").toUpperCase();rexp_noten.lastIndex=0,-1===fbs_notes.indexOf(capt_note)&&fbs_notes.push(capt_note)}),0===fbh_notes.length&&0===fbhr_notes.length&&0===fbs_notes.length?this.notes=null:this.notes={fbh:fbh_notes,fbhr:fbhr_notes,fbs:fbs_notes}}else this.notes=null},this.restoreHighlightedNotes=function(){if(null!==this.notes&&null!==this.svg_fretboard){var k=0;for(k=0;k<this.notes.fbh.length;k++)this.svg_fretboard.selectAll(".note-"+this.notes.fbh[k].toLowerCase().replace("#","s")).classed("fretboard-marker-highlighted",!0);for(k=0;k<this.notes.fbhr.length;k++)this.svg_fretboard.selectAll(".note-"+this.notes.fbhr[k].toLowerCase().replace("#","s")).classed("fretboard-marker-highlighted-root",!0);for(k=0;k<this.notes.fbs.length;k++)this.svg_fretboard.selectAll(".note-"+this.notes.fbs[k].toLowerCase().replace("#","s")).classed("fretboard-marker-selected",!0)}this.notes=null},this.updateTuning()}function comptoolsChordbuilder(cont_class){this.current_note="none",this.current_chord="none";var chordbuild_w=parseFloat(d3.select(cont_class).style("width")),chordbuild_h=parseFloat(d3.select(cont_class).style("height"));this.svg_chordbuild=d3.select(cont_class).append("svg").attr("width",chordbuild_w).attr("height",chordbuild_h);for(var the_x,the_y,now_g,circ_d=Math.floor(chordbuild_h/6),circ_r=Math.floor(circ_d/2),half_h=Math.floor(chordbuild_h/2),th_h=Math.floor(2*chordbuild_h/5),ang=-Math.PI,dang=2*Math.PI/note_array.length,k=0;k<note_array.length;k++)the_x=half_h-th_h*Math.cos(ang+dang*k),the_y=half_h-th_h*Math.sin(ang+dang*k),(now_g=this.svg_chordbuild.append("g").attr("class",CHBUILD_DEFAULT_MARKER_CLASS+" chb-n-"+note_array[k].replace("#","s").toLowerCase()).attr("id","cbnote-"+k).on("click",this.update_note())).append("circle").attr("cx",the_x).attr("cy",the_y).attr("r",circ_r),now_g.append("text").attr("text-anchor","middle").attr("x",the_x).attr("y",the_y+4).text(note_array[k]);(now_g=this.svg_chordbuild.append("g").attr("class",CHBUILD_DEFAULT_ADD_CLASS).on("click",this.add_chord_to_player())).append("circle").attr("cx",half_h).attr("cy",half_h).attr("r",circ_r),now_g.append("text").attr("text-anchor","middle").attr("x",half_h).attr("y",half_h+8).text("+");var add_y,fh=Math.floor(.8*chordbuild_h+2*circ_r),base_y=Math.floor(half_h-fh/2),base_x=Math.floor(2*half_h+2*circ_r),base_dn=Math.floor((fh-2*CHBUILD_GRID_Y*circ_r)/(CHBUILD_GRID_Y-1)+2*circ_r),base_w=6*circ_r,add_x=0,chord_str=Object.keys(chord_structures);for(k=0;k<chord_str.length;k++)now_g=this.svg_chordbuild.append("g").attr("class",CHBUILD_DEFAULT_CHORD_CLASS+" chb-c-"+chord_str[k]).attr("id","cbchord-"+k).on("click",this.update_chord()),add_x+=0!==k&&k%CHBUILD_GRID_Y==0?base_w+circ_r:0,add_y=k%CHBUILD_GRID_Y*base_dn,now_g.append("rect").attr("x",base_x+add_x).attr("y",base_y+add_y).attr("width",base_w).attr("height",2*circ_r),now_g.append("text").attr("text-anchor","middle").attr("x",base_x+add_x+Math.floor(base_w/2)).attr("y",base_y+add_y+20).text(chord_str[k])}function comptoolsChordPlayerElement(root,chord,dur,oct,leg){var my_dur="1/2";void 0!==dur&&(my_dur=dur);var my_oct=3;void 0!==oct&&(my_oct=oct);var my_leg=!1;void 0!==leg&&(my_leg=leg);var self=this,my_root="C";root=flats2sharps(root).toUpperCase().replace("H","B"),-1!==note_array.indexOf(root)?my_root=root:console.log("Wrong chord root detected. Using default value.");var my_chord="maj";chord=chord.toLowerCase(),chord_structures.hasOwnProperty(chord)?my_chord=chord:console.log("Wrong chord detected. Using default value."),this.my_root=my_root,this.my_chord=my_chord,this.timeline_id=null,this.duration_index=CHORD_LENGTHS.indexOf(my_dur),-1===this.duration_index&&(my_dur="1/2",this.duration_index=CHORD_LENGTHS.indexOf("1/2"),console.log("Wrong duration detected. Using default value.")),this.octave_index=CHORD_OCTAVES.indexOf(my_oct),-1===this.octave_index&&(my_oct=3,this.octave_index=CHORD_OCTAVES.indexOf(3),console.log("Wrong octave detected. Using default value.")),this.get_dur=function(){return CHORD_LENGTHS[this.duration_index]},this.get_oct=function(){return CHORD_OCTAVES[this.octave_index]},this.play=function(){play_chord(this.my_root,this.my_chord,this.get_oct(),get_duration_in_seconds(this.get_dur()))},this.legato=my_leg,this.elem_id="chord-list-item-"+chord_list_counter++;var my_chord_elem=CHORD_LIST_ITEM_TEMPLATE.replace("{{chord-text}}",root+" "+chord);my_chord_elem=(my_chord_elem=my_chord_elem.replace("{{chord-length}}",my_dur)).replace("{{chord-octave}}",my_oct);var chord_list_elem=d3.select("#"+CHORD_LIST_ID);this.list_elem=chord_list_elem.append("li").attr("class",CHORD_LIST_ITEM_CLASS).attr("id",this.elem_id).html(my_chord_elem),d3.select("#"+this.elem_id+" .chord-legato").classed("selected",this.legato),d3.select("#"+this.elem_id+" .chord-legato").on("click",function(){self.legato=!self.legato,d3.select(this).classed("selected",self.legato),void 0!==comptools_config.chord_player&&comptools_config.chord_player.update_callback()}),d3.select("#"+this.elem_id+" .chord-header .chord-text").on("click",this.clickHandler()),d3.select("#"+this.elem_id+" .chord-length .chord-reduce-value").on("click",function(){self.updateDuration(-1),void 0!==comptools_config.chord_player&&comptools_config.chord_player.update_callback()}),d3.select("#"+this.elem_id+" .chord-length .chord-add-value").on("click",function(){self.updateDuration(1),void 0!==comptools_config.chord_player&&comptools_config.chord_player.update_callback()}),d3.select("#"+this.elem_id+" .chord-octave .chord-reduce-value").on("click",function(){self.updateOctave(-1)}),d3.select("#"+this.elem_id+" .chord-octave .chord-add-value").on("click",function(){self.updateOctave(1)}),d3.select("#"+this.elem_id+" .chord-actions .chord-delete").on("click",function(){self.delete(),void 0!==comptools_config.chord_player&&comptools_config.chord_player.update_callback()}),d3.select("#"+this.elem_id+" .chord-actions .chord-duplicate").on("click",function(){var dup_dur=CHORD_LENGTHS[self.duration_index],dup_oct=CHORD_OCTAVES[self.octave_index],my_chord=new comptoolsChordPlayerElement(self.my_root,self.my_chord,dup_dur,dup_oct);chord_list.push(my_chord),void 0!==comptools_config.instrument_glue&&(my_chord.selection_callback=comptools_config.instrument_glue.funHighlightChordListElementNotes),void 0!==comptools_config.chord_player&&comptools_config.chord_player.update_callback()}),this.updateChord=function(note,chord){this.my_root=note,this.my_chord=chord,d3.select("#"+this.elem_id+" span.chord-text").html(note+" "+chord),this.play()},this.updateDuration=function(dir){this.duration_index+=dir,this.duration_index=saturate_value(this.duration_index,0,CHORD_LENGTHS.length-1);var my_dur=CHORD_LENGTHS[this.duration_index];d3.select("#"+this.elem_id+" .chord-length .chord-text-input").attr("value",my_dur)},this.updateOctave=function(dir){this.octave_index+=dir,this.octave_index=saturate_value(this.octave_index,0,CHORD_OCTAVES.length-1);var my_oct=CHORD_OCTAVES[this.octave_index];d3.select("#"+this.elem_id+" .chord-octave .chord-text-input").attr("value",my_oct)},this.delete=function(){return void 0!==comptools_config.chord_player&&this===comptools_config.chord_player.current_chord&&(comptools_config.chord_player.current_chord=null),this.list_elem.remove(),chord_list.remove_obj_by_prop("elem_id",this.elem_id),void 0!==comptools_config.chord_player&&comptools_config.chord_player.update_callback(),!0}}function comptoolsChordPlayer(player_class){var self=this;this.playing=!1,this.current_event_index=0,this.current_chord=null;var my_tempo=120;void 0!==comptools_config.tempo&&(my_tempo=comptools_config.tempo),d3.select(player_class).html(d3.select(player_class).html()+CHORD_LIST_CONTROL_TEMPLATE.replace("{{chord-bpm}}",my_tempo)),d3.select(player_class).html(d3.select(player_class).html()+CHORD_LIST_TEMPLATE),d3.select(player_class+" .chord-play").on("click",function(){self.togglePlay()}),Mousetrap.bind("space",function(e){self.togglePlay()}),window.onkeydown=function(e){32===e.keyCode&&e.target===document.body&&e.preventDefault()},this.togglePlay=function(){if(this.playing=!this.playing,d3.select(player_class+" .chord-play").classed("selected",this.playing),!this.playing)return Tone.Transport.stop(),void 0!==comptools_midi_player&&comptools_midi_player.ready&&comptools_midi_player.flushNoteBuffer(),!0;var now_tempo=d3.select(player_class+" .chord-bpm").property("value");if(void 0!==comptools_config.tempo&&(comptools_config.tempo=parseInt(now_tempo)),void 0===chord_list||0==chord_list.length)return d3.select(player_class+" .chord-play").classed("selected",!1),null;var myev=parse_chord_player();chord_play_events=myev.events;var start_chord=0;-1!==myev.selected_chord&&(start_chord=myev.selected_chord),Tone.Transport.cancel(0),Tone.Transport.position=myev.start_position,Tone.Transport.loopStart=0,Tone.Transport.loopEnd=myev.total_duration,Tone.Transport.loop=!0;for(var my_position=0,k=0;k<chord_play_events.length;k++)Tone.Transport.schedule(function(time){self.process_events()},my_position),my_position+=chord_play_events[k].interval;this.current_event_index=start_chord,Tone.Transport.start()},this.process_events=function(){var current_event=chord_play_events[self.current_event_index++];if(self.current_event_index>=chord_play_events.length&&(self.current_event_index=0),d3.selectAll("."+CHORD_LIST_ITEM_CLASS+" div.uk-card").classed("chord-selected",!1),d3.select("#"+current_event.highlight_id+" div.uk-card").classed("chord-selected",!0),void 0!==comptools_config.chord_builder&&comptools_config.chord_builder.set_note_chord(current_event.object.my_root,current_event.object.my_chord),void 0!==comptools_config.chord_player?this.current_chord=current_event.object:this.current_chord=null,self.update_timeline_selection(current_event.object,!0),!current_event.legato&&(player_play_chord(current_event.chord_notes,current_event.duration),void 0!==comptools_config.instrument_glue))for(var my_glue=comptools_config.instrument_glue,k=0;k<my_glue.objArray.length;k++)my_glue.objArray[k].updateNotes(current_event.highlight_notes)},this.update_timeline=function(){var my_id,ev=parse_chord_player(),my_events=ev.events,total_dur=ev.total_duration,selected_chord=ev.selected_chord,timel_w=parseFloat(d3.select("."+CHORD_PLAYER_CLASS+" .chord-player-timeline").style("width"));d3.select("."+CHORD_PLAYER_CLASS+" .chord-player-timeline").html(""),d3.select("."+CHORD_PLAYER_CLASS+" .chord-player-timeline-measures").html("");for(var k=0;k<my_events.length;k++){0===k&&(my_id="timeline-"+k);var my_obj=my_events[k].object;if(!my_events[k].legato){my_id="timeline-"+k;var my_width=Math.floor(my_events[k].duration/total_dur*timel_w)-3;d3.select("."+CHORD_PLAYER_CLASS+" .chord-player-timeline").append("div").attr("id",my_id).classed("timeline-element",!0).style("width",my_width+"px")}-1!==selected_chord&&this.update_timeline_selection(my_events[selected_chord].object,!0),my_obj.timeline_id=my_id}for(var mesw=d3.select("."+CHORD_PLAYER_CLASS+" .chord-player-timeline-measures").style("width"),mesh=d3.select("."+CHORD_PLAYER_CLASS+" .chord-player-timeline-measures").style("height"),my_svg=d3.select("."+CHORD_PLAYER_CLASS+" .chord-player-timeline-measures").append("svg").attr("width",mesw).attr("height",mesh),beatd=get_duration_in_seconds("1/"+parse_time_signature(comptools_config.time_signature)[1]),barn=parse_time_signature(comptools_config.time_signature)[0],meswi=parseInt(mesw),meshi=parseInt(mesh),pps=beatd*(meswi/total_dur),myx=0,cbeat=0;myx<=meswi;){var len=4;cbeat%barn==0&&(len=8),my_svg.append("line").attr("x1",myx).attr("x2",myx).attr("y1",meshi).attr("y2",meshi-len),myx+=pps,cbeat+=1}my_svg.append("line").attr("x1",0).attr("x2",meswi).attr("y1",meshi).attr("y2",meshi)},this.update_timeline_selection=function(obj,action){d3.selectAll("."+CHORD_PLAYER_CLASS+" .chord-player-timeline .timeline-element").classed("selected",!1),d3.select("."+CHORD_PLAYER_CLASS+" .chord-player-timeline #"+obj.timeline_id).classed("selected",action)},this.clear=function(){if(void 0!==chord_list)for(;0<chord_list.length;)chord_list[0].delete(),void 0!==comptools_config.chord_player&&comptools_config.chord_player.update_callback()},this.export_chords=function(){var play_order_ids=[];d3.selectAll("#"+CHORD_LIST_ID+" ."+CHORD_LIST_ITEM_CLASS).each(function(){play_order_ids.push(d3.select(this).attr("id"))});var k,text="";for(k=0;k<play_order_ids.length;k++){var tc=chord_list.get_obj_by_prop("elem_id",play_order_ids[k]);text+=tc.my_root+" "+tc.my_chord+" "+tc.get_dur()+" "+tc.get_oct()+(tc.legato?" leg":"")+"; "}";"===(text=text.trim()).slice(-1)&&(text=text.substr(0,text.length-1));var add_com="";return void 0!==comptools_config.theory&&"null"!==comptools_config.theory.root&&(add_com="{*Scale: "+comptools_config.theory.root+" "+comptools_config.theory.scale+"*} "),add_com+text},this.import_chords=function(text){this.clear();var k,the_chords=(text=text.replace(/{\*.*\*}/,"")).split(";");for(k=0;k<the_chords.length;k++){var chord_elem=the_chords[k].replace(/\s+/g," ").trim().split(" ");if(4===chord_elem.length||5===chord_elem.length){var my_root=chord_elem[0],my_chord=chord_elem[1],my_dur=chord_elem[2],my_oct=parseInt(chord_elem[3]),my_leg=!1;5===chord_elem.length&&"leg"===chord_elem[4]&&(my_leg=!0);my_chord=new comptoolsChordPlayerElement(my_root,my_chord,my_dur,my_oct,my_leg);chord_list.push(my_chord),void 0!==comptools_config.instrument_glue&&(my_chord.selection_callback=comptools_config.instrument_glue.funHighlightChordListElementNotes),void 0!==comptools_config.chord_player&&comptools_config.chord_player.update_callback()}}}}comptoolsTheory.prototype.clickHandler=function(){this.get_scale_data(),this.updateNotes(),this.updateAccidentals(),this.selection_callback()},comptoolsTheory.prototype.selection_callback=function(){return null},comptoolsChordProgressions.prototype.initializeMajorText=function(){for(var k in PROGBUILD_MAJOR_SVG_RELATIONS)d3.selectAll(".chord-progressions svg g."+k+" text").attr("text-anchor","middle").style("font-size","16px").text(""),d3.selectAll(".chord-progressions svg g."+k+" rect").style("fill","#fff"),d3.selectAll(".chord-progressions svg g."+k).style("cursor","pointer").on("click",function(){return null})},comptoolsChordProgressions.prototype.initializeMinorText=function(){for(var k in PROGBUILD_MINOR_SVG_RELATIONS)d3.selectAll(".chord-progressions svg g."+k+" text").attr("text-anchor","middle").style("font-size","16px").text(""),d3.selectAll(".chord-progressions svg g."+k+" rect").style("fill","#fff"),d3.selectAll(".chord-progressions svg g."+k).style("cursor","pointer").on("click",function(){return null})},comptoolsChordProgressions.prototype.clearChords=function(){for(var k in PROGBUILD_MAJOR_SVG_RELATIONS)d3.selectAll(".chord-progressions svg g."+k+" text").text(""),d3.selectAll(".chord-progressions svg g."+k).on("click",function(){return null});for(var k in PROGBUILD_MINOR_SVG_RELATIONS)d3.selectAll(".chord-progressions svg g."+k+" text").text(""),d3.selectAll(".chord-progressions svg g."+k).on("click",function(){return null})},comptoolsChordProgressions.prototype.updateChords=function(note,scale){self=this;var notes=get_scale(flats2sharps(note),scale).notes;if("major"===scale){d3.select("#id-major-progressions").style("display","block"),d3.select("#id-minor-progressions").style("display","none");var it=0;for(var k in PROGBUILD_MAJOR_SVG_RELATIONS)d3.selectAll(".chord-progressions svg g."+k+" text").text(notes[it]+" "+PROGBUILD_MAJOR_SVG_RELATIONS[k]),d3.selectAll(".chord-progressions svg g."+k).on("click",self.handle_add_chord(notes[it],PROGBUILD_MAJOR_SVG_RELATIONS[k])),it++}else if("minor"===scale){d3.select("#id-minor-progressions").style("display","block"),d3.select("#id-major-progressions").style("display","none");it=0;for(var k in PROGBUILD_MINOR_SVG_RELATIONS)d3.selectAll(".chord-progressions svg g."+k+" text").text(notes[it]+" "+PROGBUILD_MINOR_SVG_RELATIONS[k]),d3.selectAll(".chord-progressions svg g."+k).on("click",self.handle_add_chord(notes[it],PROGBUILD_MINOR_SVG_RELATIONS[k])),it++}},comptoolsChordProgressions.prototype.handle_add_chord=function(note,chord){return function(){add_chord_to_player(note,chord)}},comptoolsKeyboard.prototype.clickHandler=function(){var self=this;return function(d,i){var action=!d3.select(this).classed("keyboard-marker-selected");d3.select(this).classed("keyboard-marker-selected",action),the_note=d3.select(this).attr("class");var capt_note=/note-([a-g]s?[0-9])/gi.exec(the_note)[1].replace("s","#").toUpperCase();self.selection_callback(capt_note,action)}},comptoolsKeyboard.prototype.selection_callback=function(note,action){return null},comptoolsFretboard.prototype.clickHandler=function(){var self=this;return function(d,i){action=!d3.select(this).classed("fretboard-marker-selected"),d3.select(this).classed("fretboard-marker-selected",action),the_note=d3.select(this).attr("class");var capt_note=/note-([a-g]s?[0-9])/gi.exec(the_note)[1].replace("s","#").toUpperCase();self.selection_callback(capt_note,action)}},comptoolsFretboard.prototype.selection_callback=function(note,action){return null},comptoolsChordbuilder.prototype.update_note=function(){var self=this;return function(d,i){var this_note_index=parseInt(d3.select(this).attr("id").split("-")[1]),this_note=note_array[this_note_index];self.current_note===this_note?(self.current_note="none",d3.select(this).classed(CHBUILD_SELECTED_MARKER,!1)):(self.svg_chordbuild.selectAll("."+CHBUILD_DEFAULT_MARKER_CLASS).classed(CHBUILD_SELECTED_MARKER,!1),d3.select(this).classed(CHBUILD_SELECTED_MARKER,!0),self.current_note=this_note),self.edit_chord_in_player(),self.selection_callback()}},comptoolsChordbuilder.prototype.update_chord=function(){var self=this;return function(d,i){var this_chord=Object.keys(chord_structures)[parseInt(d3.select(this).attr("id").split("-")[1])];self.current_chord===this_chord?(self.current_chord="none",d3.select(this).classed(CHBUILD_SELECTED_MARKER,!1)):(self.svg_chordbuild.selectAll("."+CHBUILD_DEFAULT_CHORD_CLASS).classed(CHBUILD_SELECTED_MARKER,!1),d3.select(this).classed(CHBUILD_SELECTED_MARKER,!0),self.current_chord=this_chord),self.edit_chord_in_player(),self.selection_callback()}},comptoolsChordbuilder.prototype.edit_chord_in_player=function(){void 0!==comptools_config.chord_player&&null!==comptools_config.chord_player.current_chord&&"none"!==this.current_note&&"none"!==this.current_chord&&comptools_config.chord_player.current_chord.updateChord(this.current_note,this.current_chord)},comptoolsChordbuilder.prototype.set_note_chord=function(note,chord){this.current_note=note,this.current_chord=chord;var note_cl="chb-n-"+note.replace("#","s").toLowerCase(),chord_cl="chb-c-"+chord;this.svg_chordbuild.selectAll("."+CHBUILD_DEFAULT_MARKER_CLASS).classed(CHBUILD_SELECTED_MARKER,!1),this.svg_chordbuild.selectAll("."+CHBUILD_DEFAULT_CHORD_CLASS).classed(CHBUILD_SELECTED_MARKER,!1),this.svg_chordbuild.select("."+note_cl).classed(CHBUILD_SELECTED_MARKER,!0),this.svg_chordbuild.select("."+chord_cl).classed(CHBUILD_SELECTED_MARKER,!0)},comptoolsChordbuilder.prototype.add_chord_to_player=function(){var self=this;return function(d,i){"none"!==self.current_chord&&"none"!==self.current_note&&add_chord_to_player(self.current_note,self.current_chord)}},comptoolsChordbuilder.prototype.selection_callback=function(){return 0},comptoolsChordPlayerElement.prototype.clickHandler=function(){var self=this;return function(d,i){var the_elem=this.parentElement.parentElement,action=!d3.select(the_elem).classed("chord-selected");if(d3.selectAll("."+CHORD_LIST_ITEM_CLASS+" .uk-card").classed("chord-selected",!1),d3.select(the_elem).classed("chord-selected",action),void 0!==comptools_config.chord_player&&action?comptools_config.chord_player.current_chord=self:comptools_config.chord_player.current_chord=null,void 0!==comptools_config.chord_builder&&action&&comptools_config.chord_builder.set_note_chord(self.my_root,self.my_chord),void 0!==comptools_config.chord_player&&comptools_config.chord_player.update_timeline_selection(self,action),void 0!==chord_list){var my_elem_id=d3.select(the_elem.parentElement).attr("id"),my_obj=chord_list[chord_list.find_obj_by_prop("elem_id",my_elem_id)];my_obj.selection_callback(my_obj,action)}else console.log("Chord list (chord_list) is not found in scope.")}},comptoolsChordPlayerElement.prototype.selection_callback=function(my_obj){return null},comptoolsChordPlayer.prototype.update_callback=function(){this.update_timeline()},comptoolsOptions=function(){d3.select(".option-use-sound").on("change",function(){comptools_config.play_sound=d3.select(this).property("checked")})},comptoolsMIDIPlayer=function(){var self=this;this.MIDI_outputs=[],this.MIDI_current_output=null,this.midi=null,this.ready=!1,this.support=function(){return void 0!==navigator.requestMIDIAccess},this.initialize=function(){if(!this.support())return null;navigator.requestMIDIAccess().then(function(midiAccess){return self.midi=midiAccess,console.log("MIDI access is obtained."),self.MIDI_outputs=[],self.midi.outputs.forEach(function(key,port){self.MIDI_outputs.push({name:key.name,id:port})}),0<self.MIDI_outputs.length?(self.MIDI_current_output=self.MIDI_outputs[0].id,self.ready=!0,self.populateOptionsForm("option-use-midi","option-midi-output")):(self.MIDI_current_output=null,self.ready=!1,console.log("There are no available MIDI outputs.")),self},function(){console.log("Failed to get access to MIDI devices.")})},this.populateOptionsForm=function(chk_class,sel_class){var my_sel=d3.select("select."+sel_class);my_sel.html();for(var k=0;k<this.MIDI_outputs.length;k++)my_sel.append("option").attr("value",this.MIDI_outputs[k].id).text(this.MIDI_outputs[k].name);my_sel.on("change",function(d){self.MIDI_current_output=d3.select(this).property("value")}),d3.select("input."+chk_class).on("change",function(d){comptools_config.play_midi=d3.select(this).property("checked")})},this.note_buffer=[],this.flushNoteBuffer=function(){this.sendOffMessage(this.note_buffer),this.note_buffer=[]},this.sendOffMessage=function(notes,velocity){if(!this.ready)return!1;var myvel=100;void 0!==velocity&&(myvel=velocity);for(var noteOffArray=[],k=0;k<notes.length;k++){var n=get_semitone_distance(notes[k])+11;noteOffArray.push(128,n,myvel)}this.midi.outputs.get(this.MIDI_current_output).send(noteOffArray)},this.CyclicSendOnMessage=function(notes,velocity){if(!this.ready)return!1;var myvel=100;void 0!==velocity&&(myvel=velocity),this.flushNoteBuffer();for(var noteOnArray=[],k=0;k<notes.length;k++){var n=get_semitone_distance(notes[k])+11;noteOnArray.push(144,n,myvel)}this.midi.outputs.get(this.MIDI_current_output).send(noteOnArray),this.note_buffer=notes},this.sendOnOffMessage=function(notes,duration_in_ms,velocity){if(!this.ready)return!1;var myvel=100;void 0!==velocity&&(myvel=velocity);for(var noteOnArray=[],noteOffArray=[],k=0;k<notes.length;k++){var n=get_semitone_distance(notes[k])+11;noteOnArray.push(144,n,myvel),noteOffArray.push(128,n,myvel)}var output=this.midi.outputs.get(this.MIDI_current_output);return output.send(noteOnArray),output.send(noteOffArray,window.performance.now()+duration_in_ms),!0}};